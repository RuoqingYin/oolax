---
title: "Introducing Objected-orientated Loglikelihood Adjustment for Extreme Value Models"
author: "Paul Northrop, Camellia Yin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introducing Object-orientated Loglikelihood Adjustment for Extreme Value Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: oolax.bib
link-citations: yes

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The *oolax* package performs loglikelihood adjustments of extreme value models with clustered data. It uses sandwich estimator of the parameter covariate matrix, based on the methodology in @CB2007. This adjustment is built from (or, say, limited to) Generalised Extreme Value model (GEV) and generalised Pareto distribution (GPD) from packages *ismev* and *evd*.
 

## Loglikelihood adjustment using the alogLik function

The function `alogLik` returns an object of class `oolax`, `chandwich`: a function that can be used to adjust the standard error of the estimated parameters in extreme value models given clustered data. This function is designed for fitted object from `evd` and `ismev` package. The default is `cluster=NULL` which is explained in `chandwich::adjust_loglik`.
We illustrate the loglikelihood adjustments and the use of the function in *oolax* using some examples, starting from a gev fitted for clustered data.


## Extreme value modelling of maximum temperatures

We consider the example shown in Section 5.2 of @CB2007. The `owtemps` data (which can be found in *chandwich* package) contains annual maximum temperatures in Oxford and Worthing in the U.K. from 1901 to 1980. Year is considered as cluster, therefore there are 80 clusters of independent observations from a bivariate distribution. The loglikelihood adjustment is based on generalized extreme value (GEV) models which fitted by `oogev.fit`. The model is parameterized so that the marginal distribution at Oxford is GEV($\mu_0 + \mu_1, \sigma_0 + \sigma_1, \xi_0 + \xi_1$) and at Worthing is GEV($\mu_0 - \mu_1, \sigma_0 - \sigma_1, \xi_0 - \xi_1$), where GEV($\mu, \sigma, \xi$) denotes a GEV distribution with location $\mu$, scale $\sigma$ and shape $\xi$.

We perform loglikelihood adjustment for the full six-parameter model and reproduce the relevant rows of Table 2 in @CB2007.

```{r}
library(oolax)
y <- c(chandwich::owtemps[, "Oxford"], chandwich::owtemps[, "Worthing"])
x <- as.matrix(rep(c(1, -1), each = length(y) / 2))
# Fit the model by oogev.fit which allows non-stationary parameters
owfit <- oogev.fit(y, x, mul = 1, sigl = 1, shl = 1, method = "BFGS" )
year <- rep(1:(length(y) / 2), 2)
# Perform the loglikelihood adjustment of the full model
adj_owfit <- alogLik(owfit, cluster = year, cadjust = FALSE)
# Provides MLE, standard error of MLE, and adjusted standard error of MLE.
summary(adj_owfit)
```




